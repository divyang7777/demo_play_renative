{"version":3,"sources":["../../../src/core/systemManager/analytics.js"],"names":["sanitizeError","err","includes","toLowerCase","split","Redash","e","defaultProps","fingerprint","os","platform","rnvVersion","pkg","version","axios","post","REDASH_URL","headers","REDASH_KEY","catch","Analytics","errorFixer","knowItAll","Config","isAnalyticsEnabled","require","init","dsn","release","integrations","RewriteFrames","root","iteratee","frame","filename","path","sep","context","withScope","scope","extra","tags","setTags","setExtras","Error","captureException","captureEvent","Promise","resolve","client","getCurrentHub","getClient","close","then"],"mappings":"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","sourcesContent":["import { RewriteFrames } from '@sentry/integrations';\nimport { machineIdSync } from 'node-machine-id';\nimport axios from 'axios';\nimport os from 'os';\nimport path from 'path';\n\nimport Config from '../configManager/config';\nimport pkg from '../../../package.json';\nimport { REDASH_KEY, REDASH_URL } from '../constants';\n\n// deal with useless duplicate errors on sentry because of different error texts\nconst sanitizeError = (err) => {\n    if (err) {\n        if (err.includes('file if your SDK path is correct.')) {\n            return err.toLowerCase().split('. check your ')[0];\n        }\n        if (err.includes('AppConfig error - ')) {\n            return err.split(' - ')[0];\n        }\n    }\n\n    return err;\n};\n\nclass Redash {\n    captureEvent(e) {\n        const defaultProps = {\n            fingerprint: machineIdSync(),\n            os: os.platform(),\n            rnvVersion: pkg.version\n        };\n        return axios\n            .post(\n                REDASH_URL,\n                { ...e, ...defaultProps },\n                {\n                    headers: {\n                        'x-api-key': REDASH_KEY\n                    }\n                }\n            )\n            .catch(() => true);\n    }\n}\n\nclass Analytics {\n    constructor() {\n        this.errorFixer = null;\n        this.knowItAll = null;\n    }\n\n    initialize() {\n        if (Config.isAnalyticsEnabled) {\n            // ERROR HANDLING\n            // eslint-disable-next-line global-require\n            this.errorFixer = require('@sentry/node');\n\n            this.errorFixer.init({\n                dsn:\n                    'https://004caee3caa04c81a10f2ba31a945362@sentry.io/1795473',\n                release: `rnv@${pkg.version}`,\n                integrations: [\n                    new RewriteFrames({\n                        root: '/',\n                        iteratee: (frame) => {\n                            if (\n                                frame.filename.includes(\n                                    `rnv${path.sep}dist${path.sep}`\n                                )\n                                || frame.filename.includes(\n                                    `rnv${path.sep}src${path.sep}`\n                                )\n                            ) {\n                                if (\n                                    frame.filename.includes(\n                                        `rnv${path.sep}dist${path.sep}`\n                                    )\n                                ) {\n                                    frame.filename = frame.filename.split(\n                                        `rnv${path.sep}dist${path.sep}`\n                                    )[1];\n                                } else {\n                                    frame.filename = frame.filename.split(\n                                        `rnv${path.sep}src${path.sep}`\n                                    )[1];\n                                }\n                            } else if (\n                                frame.filename.includes(\n                                    `${path.sep}node_modules${path.sep}`\n                                )\n                            ) {\n                                frame.filename = `node_modules/${\n                                    frame.filename.split(\n                                        `${path.sep}node_modules${path.sep}`\n                                    )[1]\n                                }`;\n                            }\n                            return frame;\n                        }\n                    })\n                ]\n            });\n\n            // EVENT HANDLING\n            this.knowItAll = new Redash();\n        }\n    }\n\n    captureException(e, context = {}) {\n        if (Config.isAnalyticsEnabled && this.errorFixer) {\n            this.errorFixer.withScope((scope) => {\n                const { extra = {}, tags = {} } = context;\n                scope.setTags({ ...tags, os: os.platform() });\n                scope.setExtras({ ...extra, fingerprint: machineIdSync() });\n                if (e instanceof Error) {\n                    this.errorFixer.captureException(e);\n                } else {\n                    this.errorFixer.captureException(\n                        new Error(sanitizeError(e))\n                    );\n                }\n            });\n        }\n    }\n\n    async captureEvent(e) {\n        if (Config.isAnalyticsEnabled && this.knowItAll) {\n            return this.knowItAll.captureEvent(e);\n        }\n        return true;\n    }\n\n    teardown() {\n        return new Promise((resolve) => {\n            if (Config.isAnalyticsEnabled && this.errorFixer) {\n                const client = this.errorFixer.getCurrentHub().getClient();\n                if (client) {\n                    return client.close(2000).then(resolve);\n                }\n                return resolve();\n            }\n            return resolve();\n        });\n    }\n}\n\nexport default new Analytics();\n"],"file":"analytics.js"}