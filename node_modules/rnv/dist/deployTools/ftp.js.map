{"version":3,"sources":["../../src/deployTools/ftp.js"],"names":["FtpDeploy","require","dotEnv","_deployToFtp","c","platform","Promise","resolve","reject","promise","envPath","path","paths","project","dir","fs","existsSync","_createEnvFtpConfig","resolve2","readFile","err","data","toString","then","envContent","matches","targetMatches","split","map","line","forEach","key","indexOf","envPromise","config","user","process","env","RNV_DEPLOY_WEB_FTP_USER","password","RNV_DEPLOY_WEB_FTP_PASSWORD","host","RNV_DEPLOY_WEB_FTP_SERVER","port","RNV_DEPLOY_WEB_FTP_PORT","localRoot","buildConfig","platforms","deploy","DEPLOY_TARGET_FTP","remoteRoot","include","exclude","deleteRemote","forcePasv","ftpDeploy","catch","configFilePath","previousContent","inquirer","prompt","name","type","message","validate","i","default","_createDeployConfig","builds","runtime","appId","excludeSourcemaps","concat","appConfig","files","deployToFtp","targetConfig"],"mappings":"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","sourcesContent":["/* eslint-disable import/no-cycle */\nimport path from 'path';\nimport fs from 'fs';\nimport inquirer from 'inquirer';\n\nimport { logInfo, logTask } from '../systemTools/logger';\nimport { writeFileSync, fsWriteFileSync } from '../systemTools/fileutils';\nimport { DEPLOY_TARGET_FTP } from './webTools';\n\nconst FtpDeploy = require('ftp-deploy');\nconst dotEnv = require('dotenv');\n\nconst _deployToFtp = (c, platform) => new Promise((resolve, reject) => {\n    logTask(`_deployToFtp:${platform}`);\n    let promise;\n    const envPath = path.resolve(c.paths.project.dir, '.env');\n    if (!fs.existsSync(envPath)) {\n        logInfo('.env file does not exist. Creating one for you');\n        promise = _createEnvFtpConfig(envPath);\n    } else {\n        promise = new Promise((resolve2) => {\n            fs.readFile(envPath, (err, data) => {\n                if (err) return reject(err);\n                resolve2(data.toString());\n            });\n        });\n    }\n    promise\n        .then((envContent) => {\n            let matches = 0;\n            const targetMatches = 2;\n            envContent\n                .split('\\n')\n                .map(line => line.split('='))\n                .forEach(([key]) => {\n                    if (\n                        [\n                            'RNV_DEPLOY_WEB_FTP_SERVER',\n                            'RNV_DEPLOY_WEB_FTP_USER'\n                        ].indexOf(key) > -1\n                    ) {\n                        matches++;\n                    }\n                });\n            let envPromise;\n            if (matches >= targetMatches) {\n                envPromise = Promise.resolve();\n            } else {\n                logInfo(\n                    '.env file does not contain all needed FTP config, helping you to set it up'\n                );\n                envPromise = _createEnvFtpConfig(\n                    envPath,\n                    `${envContent}\\n`\n                );\n            }\n            return envPromise;\n        })\n        .then(() => {\n            dotEnv.config();\n            const config = {\n                user: process.env.RNV_DEPLOY_WEB_FTP_USER,\n                password: process.env.RNV_DEPLOY_WEB_FTP_PASSWORD, // optional, prompted if none given\n                host: process.env.RNV_DEPLOY_WEB_FTP_SERVER,\n                port: process.env.RNV_DEPLOY_WEB_FTP_PORT || 21,\n                localRoot:\n                        c.buildConfig.platforms[platform].deploy[\n                            DEPLOY_TARGET_FTP\n                        ].localRoot,\n                remoteRoot:\n                        c.buildConfig.platforms[platform].deploy[\n                            DEPLOY_TARGET_FTP\n                        ].remoteRoot || '/',\n                include: c.buildConfig.platforms[platform].deploy[\n                    DEPLOY_TARGET_FTP\n                ].include || ['*', '**/*'], // this would upload everything except dot files\n                exclude:\n                        c.buildConfig.platforms[platform].deploy[\n                            DEPLOY_TARGET_FTP\n                        ].exclude || [], // e.g. exclude sourcemaps - ** exclude: [] if nothing to exclude **\n                deleteRemote:\n                        c.buildConfig.platforms[platform].deploy[\n                            DEPLOY_TARGET_FTP\n                        ].exclude.deleteRemote || false, // delete ALL existing files at destination before uploading, if true\n                forcePasv: true // Passive mode is forced (EPSV command is not sent)\n            };\n            return config;\n        })\n        .then((config) => {\n            const ftpDeploy = new FtpDeploy();\n            return ftpDeploy.deploy(config);\n        })\n        .catch(reject);\n});\n\nconst _createEnvFtpConfig = async (configFilePath, previousContent = '') => {\n    let envContent = previousContent || '';\n\n    const { host, user, password, port } = await inquirer.prompt([\n        {\n            name: 'host',\n            type: 'input',\n            message: 'Type your FTP host',\n            validate: i => !!i || 'No FTP server provided'\n        },\n        {\n            name: 'port',\n            type: 'number',\n            message: 'Type your FTP port',\n            default: 21,\n            validate: i => !!i || 'No FTP server provided'\n        },\n        {\n            name: 'user',\n            message: 'Type your FTP user',\n            type: 'input',\n            validate: i => !!i || 'No FTP user provided'\n        },\n        {\n            name: 'password',\n            message:\n                'Type your FTP password (or press ENTER for prompting every time)',\n            type: 'password'\n        }\n    ]);\n\n    envContent += `RNV_DEPLOY_WEB_FTP_SERVER=${host}\\n`;\n    envContent += `RNV_DEPLOY_WEB_FTP_USER=${user}\\n`;\n    envContent += `RNV_DEPLOY_WEB_FTP_PASSWORD=${password}\\n`;\n    envContent += `RNV_DEPLOY_WEB_FTP_PORT=${port}`;\n\n    fsWriteFileSync(configFilePath, envContent);\n    logInfo(`Writing .env config to ${configFilePath}`);\n};\n\nconst _createDeployConfig = async (c, platform) => {\n    logTask(`_createDeployConfig:${platform}`);\n\n    const deploy = c.buildConfig.platforms[platform].deploy || {};\n\n    deploy[DEPLOY_TARGET_FTP] = {};\n    deploy[DEPLOY_TARGET_FTP].type = DEPLOY_TARGET_FTP;\n\n    deploy[DEPLOY_TARGET_FTP].localRoot = path.resolve(\n        c.paths.project.builds.dir,\n        `${c.runtime.appId}_${platform}`\n    );\n    const {\n        remoteRoot,\n        deleteRemote,\n        include,\n        exclude,\n        excludeSourcemaps\n    } = await inquirer.prompt([\n        {\n            name: 'remoteRoot',\n            type: 'input',\n            message: 'Folder on the ftp to upload the project',\n            default: '/'\n        },\n        {\n            name: 'deleteRemote',\n            type: 'confirm',\n            message:\n                'Delete all contents of that folder when deploying versions?'\n        },\n        {\n            name: 'include',\n            type: 'input',\n            message: 'Included files pattern, comma separated',\n            default: \"'*','**/*'\"\n        },\n        {\n            name: 'exclude',\n            type: 'input',\n            message: 'Excluded files pattern, comma separated',\n            default: '[]'\n        },\n        {\n            name: 'excludeSourcemaps',\n            type: 'confirm',\n            message: 'Exclude sourcemaps?'\n        }\n    ]);\n\n    deploy[DEPLOY_TARGET_FTP].remoteRoot = remoteRoot || '/';\n    deploy[DEPLOY_TARGET_FTP].deleteRemote = deleteRemote;\n    deploy[DEPLOY_TARGET_FTP].include = include\n        ? include.split(',')\n        : ['*', '**/*'];\n    deploy[DEPLOY_TARGET_FTP].exclude = exclude ? exclude.split(',') : [];\n    deploy[DEPLOY_TARGET_FTP].exclude = deploy[\n        DEPLOY_TARGET_FTP\n    ].exclude.concat(excludeSourcemaps ? ['**/*.map'] : []);\n\n    logInfo(`Setting your appconfig for ${platform} to include deploy type: ${DEPLOY_TARGET_FTP}\n                    on ${c.paths.appConfig.config}\n                `);\n\n    // TODO: Review this (where to put what props renative.*.json)\n    c.files.appConfig.config.platforms[platform].deploy = deploy;\n    writeFileSync(c.paths.appConfig.config, c.files.appConfig.config);\n};\n\nconst deployToFtp = (c, platform) => {\n    logTask(`checkDeployConfigTarget:${platform}`);\n    const targetConfig = c.buildConfig.platforms[platform];\n    if (targetConfig?.deploy?.[DEPLOY_TARGET_FTP]?.type) {\n        return _deployToFtp(c, platform);\n    }\n    return _createDeployConfig(c, platform).then(() => _deployToFtp(c, platform));\n};\n\nexport { deployToFtp };\n"],"file":"ftp.js"}