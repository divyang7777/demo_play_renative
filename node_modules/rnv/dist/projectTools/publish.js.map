{"version":3,"sources":["../../src/projectTools/publish.js"],"names":["includesPre","version","includes","rnvPublish","Config","checkRequiredPackage","pkgJson","getProjectConfig","package","existingPath","getConfig","paths","project","git","tagName","requireCleanWorkingDir","npm","publish","hooks","skipRootPublish","rootPublishCommand","args","program","rawArgs","slice","maybeVersion","secondArg","prereleaseMark","splice","semver","valid","dir","execCommonOpts","interactive","env","process","cwd","ci","publishMode","rootPublishIfNecessary","Error","releaseIt","join","catch","e","Promise","resolve","reject","then"],"mappings":"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","sourcesContent":["/* eslint-disable global-require, import/no-dynamic-require */\n/* eslint-disable import/no-cycle */\n\nimport semver from 'semver';\n\nimport Config from '../config';\nimport { executeAsync } from '../systemTools/exec';\nimport { logWarning } from '../systemTools/logger';\nimport { writeFileSync } from '../systemTools/fileutils';\n\n/*\n *\n * Usage\n * rnv publish\n * rnv publish patch|minor|major\n * rnv publish patch|minor|major alpha|beta|rc\n * rnv publish 1.0.0\n * rnv publish 1.0.0-alpha.1\n * rnv publish ... --dry-run\n *\n * Basically the same as release-it documentation. The only difference is that you don't need to specify --preRelease=beta\n * if you are publishing a beta/alpha/rc. That is done automatically by checking if the second arg is alpha, beta, rc.\n *\n */\n\nconst includesPre = (version) => {\n    if (version.includes('alpha')) return 'alpha';\n    if (version.includes('beta')) return 'beta';\n    if (version.includes('rc')) return 'rc';\n    return false;\n};\n\nconst rnvPublish = async () => {\n    // make sure release-it is installed\n    await Config.checkRequiredPackage(\n        'release-it',\n        '12.4.3',\n        'devDependencies'\n    );\n    // make sure required object is present in package.json\n    const pkgJson = Config.getProjectConfig().package;\n    const existingPath = Config.getConfig().paths.project.package;\n\n    if (!pkgJson['release-it']) {\n        pkgJson['release-it'] = {\n            git: {\n                // eslint-disable-next-line no-template-curly-in-string\n                tagName: 'v${version}',\n                requireCleanWorkingDir: false\n            },\n            npm: {\n                publish: false\n            },\n            hooks: {\n                // eslint-disable-next-line no-template-curly-in-string\n                'before:git': 'npx rnv pkg version ${version}'\n            }\n        };\n        writeFileSync(existingPath, pkgJson);\n    }\n\n    // backwards compatibility and user change friendly\n    if (!pkgJson['release-it']?.hooks?.['before:git']) {\n        if (!pkgJson['release-it'].hooks) {\n            pkgJson['release-it'].hooks = {};\n        }\n        // eslint-disable-next-line no-template-curly-in-string\n        pkgJson['release-it'].hooks['before:git'] = 'npx rnv pkg version ${version}';\n        writeFileSync(existingPath, pkgJson);\n    }\n\n    if (!pkgJson['release-it'].publish) {\n        pkgJson['release-it'].publish = 'local';\n        pkgJson['release-it'].skipRootPublish = true;\n        pkgJson['release-it'].rootPublishCommand = 'npx rnv deploy -p ios -s debug';\n        writeFileSync(existingPath, pkgJson);\n    }\n\n    let args = [...Config.getConfig().program.rawArgs];\n    args = args.slice(3);\n\n    const maybeVersion = args[0];\n    const secondArg = args[1];\n    let prereleaseMark = '';\n\n    // for handling `rnv publish patch alpha`\n    if (['alpha', 'beta', 'rc'].includes(secondArg)) {\n        args.splice(1, 1); // remove it so it won't interfere with release-it\n        prereleaseMark = `--preRelease=${secondArg}`;\n    }\n\n    // for handling `rnv publish 1.0.0-alpha.1`\n    if (semver.valid(maybeVersion) && includesPre(maybeVersion)) {\n        prereleaseMark = `--preRelease=${includesPre(maybeVersion)}`;\n    }\n\n    const { dir } = Config.getConfig().paths.project;\n    const execCommonOpts = { interactive: true, env: process.env, cwd: dir };\n    const { ci } = Config.getConfig().program;\n    const publishMode = pkgJson['release-it'].publish || 'local';\n    const { skipRootPublish, rootPublishCommand } = pkgJson['release-it'];\n\n    const rootPublishIfNecessary = async () => {\n        await executeAsync('npx rnv pkg publish', execCommonOpts);\n        if (!skipRootPublish) {\n            if (!rootPublishCommand) {\n                throw new Error(\n                    \"You don't have a rootPublishCommand specified in package.json\"\n                );\n            }\n            return executeAsync(rootPublishCommand, execCommonOpts);\n        }\n    };\n\n    const releaseIt = () => executeAsync(\n        `npx release-it ${args.join(' ')} ${prereleaseMark}`,\n        execCommonOpts\n    )\n        .catch((e) => {\n            if (e.includes('SIGINT')) return Promise.resolve();\n            if (e.includes('--no-git.requireUpstream')) {\n                return Promise.reject(\n                    new Error(\n                        'Seems like you have no upstream configured for current branch. Run `git push -u <origin> <your_branch>` to fix it then try again.'\n                    )\n                );\n            }\n            return Promise.reject(e);\n        })\n        .then(rootPublishIfNecessary);\n\n    // we have a ci flag, checking if the project is configured for ci releases to do a bumpless deploy\n    if (ci) {\n        if (publishMode !== 'ci') {\n            return logWarning(\n                'You are running publish with --ci flag but this project is set for local deployments. Check package.json release-it.publish property'\n            );\n        }\n        return rootPublishIfNecessary();\n    }\n\n    return releaseIt();\n};\n\nexport default rnvPublish;\n"],"file":"publish.js"}