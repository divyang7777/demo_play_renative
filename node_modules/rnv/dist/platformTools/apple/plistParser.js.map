{"version":3,"sources":["../../../src/platformTools/apple/plistParser.js"],"names":["parseExportOptionsPlist","c","platform","Promise","resolve","tId","appFolder","exportOptions","id","pluginConfigiOS","objToPlist","provisioningProfiles","expProvProfile","paths","appConfig","config","bPath","path","join","pattern","override","parseEntitlementsPlist","appFolderName","entitlementsPath","pluginsEntitlementsObj","rnv","dir","saveObjToPlistSync","parseInfoPlist","plat","buildConfig","platforms","orientationSupport","urlScheme","plistPath","plistObj","CFBundleDisplayName","CFBundleShortVersionString","CFBundleVersion","embeddedFonts","length","UIAppFonts","includedPermissions","permissions","platPrem","pc","Object","keys","forEach","v","key","desc","phone","UISupportedInterfaceOrientations","tab","CFBundleURLTypes","push","CFBundleTypeRole","CFBundleURLName","CFBundleURLSchemes","plist","plugin","pluginPlat","plistPlug","PLIST_START","PLIST_END","obj","output","_parseObject","level","space","i","filePath"],"mappings":"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","sourcesContent":["/* eslint-disable import/no-cycle */\nimport path from 'path';\nimport {\n    isObject,\n    isArray,\n    isBool,\n    isString\n} from '../../systemTools/objectUtils';\nimport {\n    getAppFolder,\n    getAppVersion,\n    getAppTitle,\n    getAppVersionCode,\n    getConfigProp,\n    getBuildFilePath,\n    getFlavouredProp\n} from '../../common';\nimport { logTask, logError, logWarning } from '../../systemTools/logger';\nimport { parsePlugins } from '../../pluginTools';\nimport { getAppFolderName } from './index';\nimport { readObjectSync, mergeObjects, writeCleanFile, fsWriteFileSync } from '../../systemTools/fileutils';\n\nexport const parseExportOptionsPlist = (c, platform) => new Promise((resolve) => {\n    // EXPORT OPTIONS\n    const tId = getConfigProp(c, platform, 'teamID');\n    const appFolder = getAppFolder(c, platform);\n    const exportOptions = getConfigProp(c, platform, 'exportOptions') || {};\n    const id = getConfigProp(c, platform, 'id');\n\n    c.pluginConfigiOS.exportOptions = objToPlist(exportOptions);\n\n    if (exportOptions.provisioningProfiles) {\n        const expProvProfile = exportOptions.provisioningProfiles[id];\n        if (!expProvProfile) {\n            logError(\n                `Your exportOptions.provisionProfiles object in ${c.paths.appConfig.config} does not include id ${id}!`\n            );\n        }\n    }\n\n    const bPath = getBuildFilePath(c, platform, 'exportOptions.plist');\n    writeCleanFile(bPath, path.join(appFolder, 'exportOptions.plist'), [\n        { pattern: '{{TEAM_ID}}', override: tId },\n        {\n            pattern: '{{PLUGIN_EXPORT_OPTIONS}}',\n            override: c.pluginConfigiOS.exportOptions\n        }\n    ], null, c);\n    resolve();\n});\n\nexport const parseEntitlementsPlist = (c, platform) => new Promise((resolve) => {\n    logTask(`parseEntitlementsPlistSync:${platform}`);\n\n    const appFolder = getAppFolder(c, platform);\n    const appFolderName = getAppFolderName(c, platform);\n    const entitlementsPath = path.join(\n        appFolder,\n        `${appFolderName}/${appFolderName}.entitlements`\n    );\n        // PLUGIN ENTITLEMENTS\n    let pluginsEntitlementsObj = getConfigProp(c, platform, 'entitlements');\n    if (!pluginsEntitlementsObj) {\n        pluginsEntitlementsObj = readObjectSync(\n            path.join(\n                c.paths.rnv.dir,\n                'src/platformTools/apple/supportFiles/entitlements.json'\n            )\n        );\n    }\n\n    saveObjToPlistSync(c, entitlementsPath, pluginsEntitlementsObj);\n    resolve();\n});\n\nexport const parseInfoPlist = (c, platform) => new Promise((resolve) => {\n    logTask(`parseInfoPlist:${platform}`);\n\n    const appFolder = getAppFolder(c, platform);\n    const appFolderName = getAppFolderName(c, platform);\n    const plat = c.buildConfig.platforms[platform];\n    const { orientationSupport, urlScheme } = plat;\n    const plistPath = path.join(appFolder, `${appFolderName}/Info.plist`);\n\n    // PLIST\n    let plistObj = readObjectSync(\n        path.join(\n            c.paths.rnv.dir,\n            `src/platformTools/apple/supportFiles/info.plist.${platform}.json`\n        )\n    );\n    plistObj.CFBundleDisplayName = getAppTitle(c, platform);\n    plistObj.CFBundleShortVersionString = getAppVersion(c, platform);\n    plistObj.CFBundleVersion = getAppVersionCode(c, platform);\n    // FONTS\n    if (c.pluginConfigiOS.embeddedFonts.length) {\n        plistObj.UIAppFonts = c.pluginConfigiOS.embeddedFonts;\n    }\n    // PERMISSIONS\n    const includedPermissions = getConfigProp(c, platform, 'includedPermissions')\n            || getConfigProp(c, platform, 'permissions');\n    if (includedPermissions && c.buildConfig.permissions) {\n        const platPrem = c.buildConfig.permissions[platform] ? platform : 'ios';\n        const pc = c.buildConfig.permissions[platPrem];\n        if (includedPermissions.length && includedPermissions[0] === '*') {\n            Object.keys(pc).forEach((v) => {\n                const key = pc[v].key || v;\n                plistObj[key] = pc[v].desc;\n            });\n        } else {\n            includedPermissions.forEach((v) => {\n                if (pc[v]) {\n                    const key = pc[v].key || v;\n                    plistObj[key] = pc[v].desc;\n                }\n            });\n        }\n    }\n    // ORIENATATIONS\n    if (orientationSupport) {\n        if (orientationSupport.phone) {\n            plistObj.UISupportedInterfaceOrientations = orientationSupport.phone;\n        } else {\n            plistObj.UISupportedInterfaceOrientations = [\n                'UIInterfaceOrientationPortrait'\n            ];\n        }\n        if (orientationSupport.tab) {\n            plistObj['UISupportedInterfaceOrientations~ipad'] = orientationSupport.tab;\n        } else {\n            plistObj['UISupportedInterfaceOrientations~ipad'] = [\n                'UIInterfaceOrientationPortrait'\n            ];\n        }\n    }\n    // URL_SCHEMES (LEGACY)\n    if (urlScheme) {\n        logWarning(\n            'urlScheme is DEPRECATED. use \"plist:{ CFBundleURLTypes: []}\" object instead'\n        );\n        plistObj.CFBundleURLTypes.push({\n            CFBundleTypeRole: 'Editor',\n            CFBundleURLName: urlScheme,\n            CFBundleURLSchemes: [urlScheme]\n        });\n    }\n\n    // PLIST\n    const plist = getConfigProp(c, platform, 'plist');\n    if (plist) {\n        plistObj = mergeObjects(c, plistObj, plist, true, true);\n    }\n\n    // PLUGINS\n    parsePlugins(c, platform, (plugin, pluginPlat) => {\n        const plistPlug = getFlavouredProp(c, pluginPlat, 'plist');\n        if (plistPlug) {\n            plistObj = mergeObjects(c, plistObj, plistPlug, true, false);\n        }\n    });\n    saveObjToPlistSync(c, plistPath, plistObj);\n    resolve();\n});\n\nconst PLIST_START = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\\n`;\n\nconst PLIST_END = '</plist>\\n';\n\nconst objToPlist = (obj) => {\n    let output = PLIST_START;\n    output += _parseObject(obj, 0);\n    output += PLIST_END;\n    return output;\n};\n\nconst _parseObject = (obj, level) => {\n    let output = '';\n    let space = '';\n    for (let i = 0; i < level; i++) {\n        space += '  ';\n    }\n    if (isArray(obj)) {\n        output += `${space}<array>\\n`;\n        obj.forEach((v) => {\n            output += _parseObject(v, level + 1);\n        });\n        output += `${space}</array>\\n`;\n    } else if (isBool(obj)) {\n        output += `${space}<${obj} />\\n`;\n    } else if (isObject(obj)) {\n        output += `${space}<dict>\\n`;\n        Object.keys(obj).forEach((key) => {\n            output += `  ${space}<key>${key}</key>\\n`;\n            output += _parseObject(obj[key], level + 1);\n        });\n        output += `${space}</dict>\\n`;\n    } else if (isString(obj)) {\n        output += `${space}<string>${obj}</string>\\n`;\n    }\n\n    return output;\n};\n\nconst saveObjToPlistSync = (c, filePath, obj) => {\n    // fsWriteFileSync(filePath, objToPlist(sanitizeDynamicProps(obj, c.buildConfig?._refs)));\n    fsWriteFileSync(filePath, objToPlist(obj));\n};\n\nexport { objToPlist, saveObjToPlistSync };\n"],"file":"plistParser.js"}