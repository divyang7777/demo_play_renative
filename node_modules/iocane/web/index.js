!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.iocane=n():t.iocane=n()}(window,(function(){return function(t){var n={};function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}return e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:r})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var o in t)e.d(r,o,function(n){return t[n]}.bind(null,o));return r},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=0)}([function(t,n,e){"use strict";var r;e.r(n),function(t){t.CBC="cbc",t.GCM="gcm"}(r||(r={}));var o=r.CBC,i=25e4;function a(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var u=[r.CBC,r.GCM];function c(t){if(-1===u.indexOf(t))throw new Error("Invalid encryption/decryption method: ".concat(t))}function f(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(t,n,e){return e?n?n(t):t:(t&&t.then||(t=Promise.resolve(t)),n?t.then(n):t)}function l(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function y(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function p(t){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t,n){return(d=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}var h=function(t){function n(){return function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),y(this,p(n).apply(this,arguments))}var e,o,i;return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&d(t,n)}(n,t),e=n,(o=[{key:"decrypt",value:function(t,n){try{var e="string"==typeof t?this.options.unpack_text(t):this.options.unpack_data(t),r=e.salt,o=e.rounds,i=e.method,a=this.options["decryption_".concat(i)];return s(this._deriveKey(n,r,o,i),(function(t){return a(e,t)}))}catch(t){return Promise.reject(t)}}},{key:"encrypt",value:function(t,n){try{var e=this,r=e.options,o=r.generateIV,i=r.method,a=e.options["encryption_".concat(i)];return s(Promise.all([e._deriveNewKey(n),o()]),(function(n){var r=f(n,2),o=r[0],i=r[1];return s(a(t,o,i),(function(n){return"string"==typeof t?e.options.pack_text(n):e.options.pack_data(n)}))}))}catch(t){return Promise.reject(t)}}},{key:"_deriveKey",value:function(t,n,e,o){var i=this.options,a=i.derivationRounds,u=i.method,c=i.pbkdf2,f=o||u,s=this.options.deriveKey;return(f===r.GCM?function(){return s(c,t,n,e||a,!1)}:function(){return s(c,t,n,e||a)})()}},{key:"_deriveNewKey",value:function(t){try{var n=this,e=n.options;return s((0,e.generateSalt)(e.saltLength),(function(e){return n._deriveKey(t,e)}))}catch(t){return Promise.reject(t)}}}])&&l(e.prototype,o),i&&l(e,i),n}(function(){function t(n){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this._baseOptions=Object.assign({},n),this._options=n}var n,e,r;return n=t,(e=[{key:"overrideDecryption",value:function(t,n){return c(t),this._options["decryption_".concat(t)]=n||this._baseOptions["decryption_".concat(t)],this}},{key:"overrideEncryption",value:function(t,n){return c(t),this._options["encryption_".concat(t)]=n||this._baseOptions["encryption_".concat(t)],this}},{key:"overrideIVGeneration",value:function(t){return this._options.generateIV=t||this._baseOptions.generateIV,this}},{key:"overrideKeyDerivation",value:function(t){return this._options.deriveKey=t||this._baseOptions.deriveKey,this}},{key:"overrideSaltGeneration",value:function(t){return this._options.generateSalt=t||this._baseOptions.generateSalt,this}},{key:"reset",value:function(){return this._options=this._baseOptions,this}},{key:"setDerivationRounds",value:function(t){return void 0===t?this._options.derivationRounds=i:"number"==typeof t&&(this._options.derivationRounds=t),this}},{key:"use",value:function(t){return c(t),this._options.method=t,this}},{key:"options",get:function(){return Object.assign({},this._options)}}])&&a(n.prototype,e),r&&a(n,r),t}());function v(t){var n=Array.from(new Uint8Array(t)).map((function(t){return String.fromCharCode(t)})).join("");return btoa(n)}function b(t){for(var n,e=new Uint8Array(t),r="",o=0;o<e.byteLength;o+=1)(n=e[o].toString(16)).length<2&&(n="0"+n),r+=n;return r}function m(t){return(new TextDecoder).decode(t)}function w(t){for(var n=atob(t),e=new Uint8Array(new ArrayBuffer(n.length)),r=0;r<n.length;r+=1)e[r]=n.charCodeAt(r);return e.buffer}function g(t){if(t.length<=0)throw new Error("Failed concatenating array buffers: At least one must be passed");var n=t.reduce((function(t,n){return t+n.byteLength}),0),e=new Uint8Array(n),r=0;return t.forEach((function(t){e.set(new Uint8Array(t),r),r+=t.byteLength})),e.buffer}function _(t){var n=t.match(/[\da-f]{2}/gi).map((function(t){return parseInt(t,16)}));return new Uint8Array(n).buffer}function A(t){return(new TextEncoder).encode(t)}function j(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function S(t,n,e){return e?n?n(t):t:(t&&t.then||(t=Promise.resolve(t)),n?t.then(n):t)}function O(t){return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];try{return Promise.resolve(t.apply(this,n))}catch(t){return Promise.reject(t)}}}var k=O((function(t,n,e,r){!function(){if(!window.TextEncoder||!window.TextDecoder)throw new Error("TextEncoder is not available")}();var o=window.crypto.subtle,i={name:"PBKDF2",hash:"SHA-256",salt:A(n),iterations:e},a=r/8/2;return S(o.importKey("raw",A(t),{name:"PBKDF2"},!1,["deriveBits"]),(function(t){return S(o.deriveBits(i,t,r),(function(t){return S(Promise.all([o.importKey("raw",t.slice(0,a),"AES-CBC",!0,["encrypt","decrypt"]),o.importKey("raw",t.slice(a,2*a),"AES-CBC",!0,["encrypt","decrypt"])]),(function(t){var n=j(t,2),e=n[0],r=n[1];return S(Promise.all([o.exportKey("raw",e),o.exportKey("raw",r)]),(function(t){var n,e,r=j(t,2),o=r[0],i=r[1];return n=g([o,i]),e=n.toString||function(){},n.toString=function(t){return"hex"===t?b(n):e.call(n,t)},n}))}))}))}))})),C=O((function(t,n,e,r){var o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!n)throw new Error("Failed deriving key: Password must be provided");if(!e)throw new Error("Failed deriving key: Salt must be provided");if(!r||r<=0)throw new Error("Failed deriving key: Rounds must be greater than 0");var i=o?8*(E+x):8*E;return S(t(n,e,r,i),(function(t){var n=t.toString("hex"),i=n.length,a=_(o?n.substr(0,i/2):n);return{salt:e,key:a,rounds:r,hmac:o?_(n.substr(i/2,i/2)):null}}))})),x=32,E=32;function P(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function K(t,n,e){return e?n?n(t):t:(t&&t.then||(t=Promise.resolve(t)),n?t.then(n):t)}function I(t){return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];try{return Promise.resolve(t.apply(this,n))}catch(t){return Promise.reject(t)}}}var U=I((function(t){if(t<=0)throw new Error("Failed generating salt: Invalid length supplied: ".concat(t));for(var n=N(),e="";e.length<t;){var r=new Uint8Array(3);n.getRandomValues(r);var o=r.reduce((function(t,n){return t+String.fromCharCode(n)}),"");(e+=btoa(o)).length>t&&(e=e.substr(0,t))}return e})),T=I((function(){var t=new Uint8Array(16);return N().getRandomValues(t),t.buffer})),B=I((function(t,n,e){var o=N(),i=n.rounds,a=new Uint8Array(e),u=b(e),c="string"==typeof t,f=c?A(t):t;return K(o.subtle.importKey("raw",n.key,{name:R},!1,["encrypt"]),(function(t){return K(o.subtle.encrypt({name:R,iv:a,additionalData:A("".concat(u).concat(n.salt))},t,f),(function(t){var e,o,a,f,s=P((o=V/8,a=(e=t).slice(0,e.byteLength-o),f=e.slice(e.byteLength-o),[a,f]),2),l=s[0],y=b(s[1]),p=c?v(l):l,d={method:r.GCM,iv:u,salt:n.salt,rounds:i,content:p,auth:y};return d}))}))})),L=I((function(t,n,e){var o=N(),i=n.rounds,a=n.salt,u=new Uint16Array(e),c=b(e),f="string"==typeof t,s=f?A(t):t;return K(o.subtle.importKey("raw",n.key,{name:F},!1,["encrypt"]),(function(t){return K(o.subtle.importKey("raw",n.hmac,{name:H,hash:G},!1,["sign"]),(function(n){return K(o.subtle.encrypt({name:F,iv:u},t,s),(function(t){var e=f?v(t):t,o=f?A("".concat(e).concat(c).concat(a)):g([e,A(c),A(a)]);return K(window.crypto.subtle.sign(H,n,o),(function(t){var n=b(t),o={method:r.CBC,auth:n,iv:c,salt:a,rounds:i,content:e};return o}))}))}))}))})),D=I((function(t,n){var e=N(),r=t.auth,o=t.content,i=t.iv,a=t.salt,u=_(i),c=_(r),f="string"==typeof o,s=g(f?[w(o),c]:[o,c]);return K(e.subtle.importKey("raw",n.key,{name:R},!1,["decrypt"]),(function(t){return K(e.subtle.decrypt({name:R,iv:u,additionalData:A("".concat(i).concat(a))},t,s),(function(t){return f?m(t):t}))}))})),M=I((function(t,n){var e=N(),r=t.auth,o=t.content,i=t.iv,a=t.salt,u=_(i),c=A(i),f=A(a),s=_(r),l="string"==typeof o,y=l?w(o):o;return K(e.subtle.importKey("raw",n.key,{name:F},!1,["decrypt"]),(function(t){return K(e.subtle.importKey("raw",n.hmac,{name:H,hash:G},!1,["verify"]),(function(n){var r=l?A("".concat(o).concat(i).concat(a)):g([y,c,f]);return K(e.subtle.verify(H,n,s,r),(function(n){if(!n)throw new Error("Authentication failed while decrypting content");return K(e.subtle.decrypt({name:F,iv:u},t,y),(function(t){return l?m(t):t}))}))}))}))})),F="AES-CBC",R="AES-GCM",V=128,G="SHA-256",H="HMAC";function N(){return window.crypto||window.msCrypto}function $(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var q=1e3;function z(){return"iocane/1".split("").map((function(t){return t.charCodeAt(0)}))}function J(t){return[t.content,t.iv,t.salt,t.auth,t.rounds,t.method].join("$")}function Q(t){var n=$(t.split("$"),6),e=n[0],r=n[1],i=n[2],a=n[3],u=n[4],c=n[5];return{content:e,iv:r,salt:i,auth:a,rounds:u?parseInt(u,10):q,method:c||o}}function W(t){return function(t){if(Array.isArray(t)){for(var n=0,e=new Array(t.length);n<t.length;n++)e[n]=t[n];return e}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var X=4;function Y(t){var n=new Uint8Array(z()).buffer,e=t.content,r=t.iv,o=t.salt,i=t.auth,a=t.rounds,u=t.method;return g([n].concat(W([e,r,o,i,a,u].reduce((function(t,n){var e,r,o;if("string"==typeof n||"number"==typeof n)e=A("".concat(n));else{if(!(n instanceof ArrayBuffer))throw new Error("Failed packing data: Invalid component type: ".concat(typeof n));e=n}return t.push((r=e.byteLength,o=new ArrayBuffer(4),new DataView(o).setUint32(0,r,!1),o)),t.push(e),t}),[]))))}function Z(t){var n=new Uint8Array(z()).buffer,e=n.byteLength;if(!function(t,n){if(t.byteLength!==n.byteLength)return!1;for(var e=new Uint8Array(t),r=new Uint8Array(n),o=0;o<t.byteLength;o+=1)if(e[o]!==r[o])return!1;return!0}(t.slice(0,e),n))throw new Error("Failed unpacking data: Signature mismatch");for(var r=e,o=[],i=new DataView(t);r<t.byteLength;){var a=i.getUint32(r);r+=X;var u=t.slice(r,r+a);r+=a,o.push(u)}var c=o[0],f=o[1],s=o[2],l=o[3],y=o[4],p=o[5];return{content:c,iv:m(f),salt:m(s),auth:m(l),rounds:parseInt(m(y),10),method:m(p)}}var tt=12;function nt(){return new h({decryption_cbc:M,decryption_gcm:D,derivationRounds:i,deriveKey:C,encryption_cbc:L,encryption_gcm:B,generateIV:T,generateSalt:U,method:o,pack_data:Y,pack_text:J,pbkdf2:k,saltLength:tt,unpack_data:Z,unpack_text:Q})}e.d(n,"createSession",(function(){return nt}))}])}));